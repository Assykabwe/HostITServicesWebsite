<?php
session_start();
include '../Includes/db_connection.php';
header('Content-Type: application/json');

// Ensure session cart exists
if (!isset($_SESSION['cart']) || !is_array($_SESSION['cart'])) {
    $_SESSION['cart'] = [];
}

$user_id = $_SESSION['User_ID'] ?? null;

if ($user_id) {
    // Fetch cart items from database
    $stmt = $mysqli->prepare("SELECT * FROM cart WHERE user_id = ?");
    $stmt->bind_param("i", $user_id);
    $stmt->execute();
    $res = $stmt->get_result();

    // Reset session cart
    $_SESSION['cart'] = [];

    while ($row = $res->fetch_assoc()) {
        $_SESSION['cart'][] = [
            'id' => $row['id'],
            'service_id' => $row['service_id'],
            'service_title' => $row['service_title'] ?? 'No Title',
            'category_name' => $row['category_name'] ?? 'No Category',
            'domain_name' => $row['domain_name'] ?? null,
            'price' => floatval($row['price'] ?? 0),
            'quantity' => intval($row['quantity'] ?? 1),
            'billing_cycle' => $row['billing_cycle'] ?? ($row['domain_name'] ? 'yearly' : 'monthly')
        ];
    }

    $stmt->close();
}

// Prepare cart details for JS
$cart_total = 0;
$cart_with_details = [];

foreach ($_SESSION['cart'] as $item) {
    $unitPrice = floatval($item['price']);
    $quantity = intval($item['quantity']);
    $lineTotal = $unitPrice * $quantity;
    $cart_total += $lineTotal;

    $cart_with_details[] = [
        'id' => $item['id'],
        'service_id' => $item['service_id'],
        'service_title' => $item['service_title'],
        'category_name' => $item['category_name'],
        'domain_name' => $item['domain_name'],
        'price' => $unitPrice,
        'quantity' => $quantity,
        'line_total' => $lineTotal,
        'billing_cycle' => $item['billing_cycle']
    ];
}

// Output JSON
echo json_encode([
    'status' => 'success',
    'cart' => $cart_with_details,
    'cart_count' => count($cart_with_details),
    'cart_total' => $cart_total
]);
?>
